{% extends "base.html" %}

{% block title %}Dashboard - Subscription Tracker{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h3>${{ "%.2f"|format(total_monthly) }}</h3>
                <p class="mb-0">Monthly Total</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h3>${{ "%.2f"|format(total_yearly) }}</h3>
                <p class="mb-0">Yearly Total</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h3>{{ subscriptions|length }}</h3>
                <p class="mb-0">Total Subscriptions</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <h3>{{ expiring_soon|length }}</h3>
                <p class="mb-0">Expiring Soon</p>
            </div>
        </div>
    </div>
</div>

{% if expiring_soon %}
<div class="alert alert-warning" role="alert">
    <h4 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Subscriptions Expiring Soon!</h4>
    <p>You have {{ expiring_soon|length }} subscription(s) expiring within your notification window:</p>
    <hr>
    {% for sub in expiring_soon %}
    <div class="d-flex justify-content-between align-items-center mb-2">
        <span><strong>{{ sub.name }}</strong> ({{ sub.company }}) - Expires in {{ sub.days_until_expiry() }} day(s)</span>
        <a href="{{ url_for('main.edit_subscription', id=sub.id) }}" class="btn btn-sm btn-outline-warning">
            <i class="fas fa-edit me-1"></i>Edit
        </a>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="mb-0"><i class="fas fa-list me-2"></i>Your Subscriptions</h2>
        <a href="{{ url_for('main.add_subscription') }}" class="btn btn-light">
            <i class="fas fa-plus me-1"></i>Add Subscription
        </a>
    </div>
    <div class="card-body">
        <!-- Filters -->
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="categoryFilter" class="form-label">Filter by Category:</label>
                <select id="categoryFilter" class="form-select" onchange="applyFilters()">
                    <option value="all" {{ 'selected' if current_category == 'all' else '' }}>All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category }}" {{ 'selected' if current_category == category else '' }}>
                        {{ category|replace('_', ' ')|title }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="statusFilter" class="form-label">Filter by Status:</label>
                <select id="statusFilter" class="form-select" onchange="applyFilters()">
                    <option value="all" {{ 'selected' if current_status == 'all' else '' }}>All Subscriptions</option>
                    <option value="active" {{ 'selected' if current_status == 'active' else '' }}>Active Only</option>
                    <option value="inactive" {{ 'selected' if current_status == 'inactive' else '' }}>Inactive Only</option>
                    <option value="expiring" {{ 'selected' if current_status == 'expiring' else '' }}>Expiring Soon</option>
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                    <i class="fas fa-times me-1"></i>Clear Filters
                </button>
            </div>
        </div>

        {% if subscriptions %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th><i class="fas fa-tag me-1"></i>Name</th>
                        <th><i class="fas fa-building me-1"></i>Company</th>
                        <th><i class="fas fa-folder me-1"></i>Category</th>
                        <th><i class="fas fa-dollar-sign me-1"></i>Cost</th>
                        <th><i class="fas fa-calendar me-1"></i>Cycle</th>
                        <th><i class="fas fa-calculator me-1"></i>Monthly</th>
                        <th><i class="fas fa-play me-1"></i>Start</th>
                        <th><i class="fas fa-stop me-1"></i>End</th>
                        <th><i class="fas fa-toggle-on me-1"></i>Status</th>
                        <th><i class="fas fa-cogs me-1"></i>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sub in subscriptions %}
                    <tr class="{{ 'table-warning' if sub.is_expiring_soon(7) else '' }}">
                        <td>
                            <strong>{{ sub.name }}</strong>
                            {% if sub.notes %}
                                <i class="fas fa-sticky-note text-muted ms-1" title="{{ sub.notes }}" data-bs-toggle="tooltip"></i>
                            {% endif %}
                        </td>
                        <td>{{ sub.company }}</td>
                        <td>
                            {% if sub.category %}
                                <span class="badge bg-secondary">{{ sub.category|replace('_', ' ')|title }}</span>
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>${{ "%.2f"|format(sub.cost) }}</td>
                        <td>
                            {% if sub.billing_cycle == 'custom' %}
                                <span class="badge bg-info">Every {{ sub.custom_days }} days</span>
                            {% else %}
                                <span class="badge bg-primary">{{ sub.billing_cycle|title }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <strong>${{ "%.2f"|format(sub.get_monthly_cost()) }}</strong>
                        </td>
                        <td>{{ sub.start_date.strftime('%m/%d/%Y') }}</td>
                        <td>
                            {% if sub.end_date %}
                                {{ sub.end_date.strftime('%m/%d/%Y') }}
                                {% set days_left = sub.days_until_expiry() %}
                                {% if days_left is not none %}
                                    <br>
                                    {% if days_left <= 3 %}
                                        <small class="text-danger">({{ days_left }} days left)</small>
                                    {% elif days_left <= 7 %}
                                        <small class="text-warning">({{ days_left }} days left)</small>
                                    {% else %}
                                        <small class="text-muted">({{ days_left }} days left)</small>
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                <span class="badge bg-success">Infinite</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if sub.is_active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('main.edit_subscription', id=sub.id) }}" 
                                   class="btn btn-sm btn-outline-primary" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{{ url_for('main.toggle_subscription', id=sub.id) }}" 
                                   class="btn btn-sm btn-outline-{{ 'secondary' if sub.is_active else 'success' }}" 
                                   title="{{ 'Deactivate' if sub.is_active else 'Activate' }}">
                                    <i class="fas fa-toggle-{{ 'off' if sub.is_active else 'on' }}"></i>
                                </a>
                                <a href="{{ url_for('main.delete_subscription', id=sub.id) }}" 
                                   class="btn btn-sm btn-outline-danger" 
                                   title="Delete"
                                   onclick="return confirm('Are you sure you want to delete this subscription?')">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
            <h4>No subscriptions found</h4>
            <p class="text-muted">Get started by adding your first subscription!</p>
            <a href="{{ url_for('main.add_subscription') }}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>Add Your First Subscription
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })

    function applyFilters() {
        const category = document.getElementById('categoryFilter').value;
        const status = document.getElementById('statusFilter').value;
        
        const url = new URL(window.location);
        url.searchParams.set('category', category);
        url.searchParams.set('status', status);
        
        window.location.href = url.toString();
    }

    function clearFilters() {
        window.location.href = '{{ url_for("main.dashboard") }}';
    }
</script>
{% endblock %}
